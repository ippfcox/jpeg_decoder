# JPEG编码原理

补充一下JPEG的编码原理

文中可能有些疏忽，还请不吝指出，非常感谢！

## 总

JPEG编码在原理上主要分为降采样、频域变换、量化、编码几步

### 降采样

我们最常用也最好理解的图像是RGB，可能再带上透明度A，这样的图像没有太大的问题，bmp基本上也就是这样的，再加上一个文件头而已

一副1920x1080的图像要占据的空间为$1920\times1080\times3=6220800(byte)\approx5.93MB$，这样就太大了

考虑到人眼是有局限性的，人眼对亮度更加敏感，而对色度和饱和度的敏感程度低一些，因此引入YUV颜色空间，其中Y为亮度，U和V分别为色度和饱和度

> *查一下YUV与YCbCr的区别*

一般的RGB排列方式为RGBRGBRGBRGB...，每个像素的RGB都是在一起的，YUV存在很多中排列方式

首先从YUV的采样方式说起，仍以1920x1080的图像举例，Y是不变的，始终是1920x1080的大小，根据UV采样方式的区别，分成3种情况

1. YUV444：U和V也都是1920x1080，每个YUV都是一一对应的，这样的YUV与RGB占据的空间相同
2. YUV422：U和V都是960x1080，水平方向采样了一半，这样YUV占据$\frac{2}{3}$ RGB图像空间
3. YUV420：U和V都是960x540，水平和垂直方向均采样了一半，这样YUV占据$\frac{1}{2}$ RGB图像空间

所以YUV可以在不损失主观观感的情况下大幅降低空间占用，因此，JPEG编码的第一步就是将RGB转换至YUV空间

另外，YUV444/422/420仅仅说明了Y分量与另外的分量的采样关系，实际使用中，排列方式非常多，这里不详细解释，但有个概念需要说明：planer

- 如果我们的YUV分别排列，即YYYYYYYY...UU...VV...，我们称它有3个planer，有些程序中会定义为YUV420_Planer
- 如果我们的UV交错排列，即YYYYYYYY...UVUV...，我们称它有2个planer，这样的排列也叫semi-planer，程序中定义为YUV420_Semiplaner
- 如果我们的YUV都交错排列，即YUVYUV...，即1个planer，叫做packed

### 频域变换

这算是信号相关专业的基础知识了，[DBinary](https://www.zhihu.com/people/DBinary)在知乎的相关专栏写得非常详细，可以作为参考

频域变换的目的很简单，人眼对高频分量不敏感，因此我们变换到频域并去除高频分量，即可减少信息量

JPEG对图像的处理是分块进行的，首先将图像分割为多个MCU，每个MCU由多个block组成，这些block又分为Y block、Cb block、Cr block，根据不同的采样方式，每个MCU中包含的block个数也不一样，比如常用的YUV420，那么Y的水平和垂直采样率都为2，Cb、Cr都为1，一个MCU中将包含6个block，4个Y block、1个Cb block，1个Cr block，一个MCU在进行解码之后其实就是一块16x16的图像（这里暂时不谈直流分量的DPCM）

JPEG采用的是DCT变换，变换是以block为单位进行的，变换之后，可以简单理解为，越接近左上角的，越是低频能量，越接近右下角的，越是高频能量，得到频域变换之后，就可以继续处理了

### 量化

量化过程实际就是一个滤波器，消除了高频分量，保留了低频分量，在具体操作上，是与量化表进行了除法操作

可以想象，去除了高频分量的block，大概是一个能量更集中于左上角的数据，在介绍具体的处理之前，我们先讲后续的处理

简单来说，如果我们有一堆数据，它有30个0，那么，最好的描述就是“30个0”，JPEG中就用了这种方法，被称为“RLE，Run Length Encoding”

因此我们需要让我们的量化结果数据在变成一维数组的过程中0能集中在一起，其实就是通过ZigZag或称为Z形扫描的方式，此时我们得到了一堆0集中在一块的一维数据

### 变长编码

这部分主要用到的除了前面提到的RLE以外，JPEG使用了熵编码，这里使用的是huffman编码

huffman编码的细节不在这里叙述（主要我也没去了解过实现），其原理好理解，我们有一堆数据，各个数值出现的频率是不一样的，如果我们根据各数据出现的频率来指定变长码字：出现频率越高，使用的编码码字越短，这样就可以尽可能降低编码后的数据量了，码字经过设计，也可以保证长码字的前面部分不会与短码字碰撞

## 结

总体流程大概是这些，由于我还没有实现过编码器，仅仅从解码的流程以及互联网的部分资料来推测编码流程，一定会有许多不足

主要目的还是以自己的理解来说明其编码的整体原理